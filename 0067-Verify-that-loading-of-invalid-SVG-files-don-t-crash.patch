From 7eb8f63915a470b89b96eb274252543a22e774a7 Mon Sep 17 00:00:00 2001
From: Paul Olav Tvete <paul.tvete@qt.io>
Date: Tue, 10 Oct 2023 14:25:19 +0200
Subject: [PATCH 67/81] Verify that loading of invalid SVG files don't crash

Also verify that we don't try to load invalid SVGs
twice.

Pick-to: 6.6 6.5
Task-number: QTBUG-117944
Change-Id: If3938384940112510d64a675f58c1e4e97e74986
Reviewed-by: Eskil Abrahamsen Blomfeldt <eskil.abrahamsen-blomfeldt@qt.io>
---
 tests/auto/qsvgplugin/CMakeLists.txt         |  3 +++
 tests/auto/qsvgplugin/invalid_then_valid.svg | 18 ++++++++++++++++++
 tests/auto/qsvgplugin/invalid_xml.svg        |  2 ++
 tests/auto/qsvgplugin/tst_qsvgplugin.cpp     | 12 ++++++++++++
 tests/auto/qsvgplugin/xml_not_svg.svg        | 13 +++++++++++++
 5 files changed, 48 insertions(+)
 create mode 100644 tests/auto/qsvgplugin/invalid_then_valid.svg
 create mode 100644 tests/auto/qsvgplugin/invalid_xml.svg
 create mode 100644 tests/auto/qsvgplugin/xml_not_svg.svg

diff --git a/tests/auto/qsvgplugin/CMakeLists.txt b/tests/auto/qsvgplugin/CMakeLists.txt
index 9124d77..ba3cdc4 100644
--- a/tests/auto/qsvgplugin/CMakeLists.txt
+++ b/tests/auto/qsvgplugin/CMakeLists.txt
@@ -42,6 +42,9 @@ set(resources_resource_files
     "simple_Utf16BE.svg"
     "simple_Utf32LE.svg"
     "simple_Utf32BE.svg"
+    "invalid_xml.svg"
+    "xml_not_svg.svg"
+    "invalid_then_valid.svg"
 )
 
 qt_internal_add_resource(tst_qsvgplugin "resources"
diff --git a/tests/auto/qsvgplugin/invalid_then_valid.svg b/tests/auto/qsvgplugin/invalid_then_valid.svg
new file mode 100644
index 0000000..d09f598
--- /dev/null
+++ b/tests/auto/qsvgplugin/invalid_then_valid.svg
@@ -0,0 +1,18 @@
+<!-- html-header type=current begin -->
+	
+	<!DOCTYPE html>
+	
+	<html lang="en">
+	<head>
+	<!-- Render IE9 -->
+	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
+	</head>
+
+<body class="anon comments ">
+
+</body></html>
+<?xml version="1.0" encoding="UTF-8" standalone="no"?>
+<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.0//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
+<svg version="1.0" xmlns="http://www.w3.org/2000/svg">
+  <circle cx="50" cy="50" r="25" fill="#00ff00" />
+</svg>
diff --git a/tests/auto/qsvgplugin/invalid_xml.svg b/tests/auto/qsvgplugin/invalid_xml.svg
new file mode 100644
index 0000000..e0814ae
--- /dev/null
+++ b/tests/auto/qsvgplugin/invalid_xml.svg
@@ -0,0 +1,2 @@
+<!--abcd
+
diff --git a/tests/auto/qsvgplugin/tst_qsvgplugin.cpp b/tests/auto/qsvgplugin/tst_qsvgplugin.cpp
index 8bb401d..762d373 100644
--- a/tests/auto/qsvgplugin/tst_qsvgplugin.cpp
+++ b/tests/auto/qsvgplugin/tst_qsvgplugin.cpp
@@ -67,6 +67,9 @@ void tst_QSvgPlugin::checkSize_data()
     QTest::newRow("wide_size")           << QFINDTESTDATA("wide_size.svg")           << 100 << 200;
     QTest::newRow("wide_size_viewbox")   << QFINDTESTDATA("wide_size_viewbox.svg")   << 100 << 200;
     QTest::newRow("wide_viewbox")        << QFINDTESTDATA("wide_viewbox.svg")        <<  50 << 100;
+    QTest::newRow("invalid_xml")         << QFINDTESTDATA("invalid_xml.svg")         <<  0 << 0;
+    QTest::newRow("xml_not_svg")         << QFINDTESTDATA("xml_not_svg.svg")         <<  0 << 0;
+    QTest::newRow("invalid_then_valid")  << QFINDTESTDATA("invalid_then_valid.svg")  <<  0 << 0;
 }
 
 void tst_QSvgPlugin::checkSize()
@@ -84,10 +87,19 @@ void tst_QSvgPlugin::checkSize()
     QImage image;
     plugin.read(&image);
 
+    // Check that plugin survives double load
+    QVariant sizeVariant = plugin.option(QImageIOHandler::Size);
+
     file.close();
 
     QCOMPARE(imageHeight, image.height());
     QCOMPARE(imageWidth, image.width());
+
+    QSize size = qvariant_cast<QSize>(sizeVariant);
+    if (size.isEmpty())
+        size = QSize(0, 0); // don't distinguish between null and invalid QSize
+    QCOMPARE(size.width(), imageWidth);
+    QCOMPARE(size.height(), imageHeight);
 }
 
 void tst_QSvgPlugin::checkImageInclude()
diff --git a/tests/auto/qsvgplugin/xml_not_svg.svg b/tests/auto/qsvgplugin/xml_not_svg.svg
new file mode 100644
index 0000000..ccefc72
--- /dev/null
+++ b/tests/auto/qsvgplugin/xml_not_svg.svg
@@ -0,0 +1,13 @@
+<!-- html-header type=current begin -->
+	
+	<!DOCTYPE html>
+	
+	<html lang="en">
+	<head>
+	<!-- Render IE9 -->
+	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
+	</head>
+
+<body class="anon comments ">
+
+</body></html>
-- 
2.42.1

